<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnPro - Play & Earn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src='//libtl.com/sdk.js' data-zone='10454238' data-sdk='show_10454238'></script>

    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; user-select: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; }
        .game-card { transition: all 0.3s; cursor: pointer; border: 1px solid #334155; }
        .game-card:hover { transform: translateY(-5px); border-color: #8b5cf6; box-shadow: 0 10px 20px -10px rgba(139, 92, 246, 0.5); }
        .hidden { display: none !important; }
        
        /* Telegram Button Style */
        .telegram-btn { background-color: #54A9EB; color: white; }
        .telegram-btn:hover { background-color: #4092d1; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 relative overflow-x-hidden">

    <div id="login-section" class="w-full max-w-md mt-10 text-center glass p-8 shadow-2xl z-10">
        <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-2">GameEarner</h1>
        <p class="text-gray-400 mb-8">Login to Start Earning</p>
        
        <button onclick="googleLogin()" class="w-full bg-white text-gray-900 font-bold py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-200 transition mb-4">
            <i class="fab fa-google text-red-500"></i> Continue with Google
        </button>

        <div class="flex items-center justify-center gap-2 mb-4">
            <div class="h-px bg-gray-600 w-full"></div>
            <span class="text-gray-500 text-sm">OR</span>
            <div class="h-px bg-gray-600 w-full"></div>
        </div>

        <p class="text-sm text-gray-400 mb-2">Login with Telegram</p>
        <div id="telegram-login-container" class="flex justify-center">
            <script async src="https://telegram.org/js/telegram-widget.js?22" 
                    data-telegram-login="EarningPro1_bot" 
                    data-size="large" 
                    data-onauth="onTelegramAuth(user)" 
                    data-request-access="write"></script>
        </div>
        <p class="text-xs text-gray-500 mt-2">Make sure to start the bot first!</p>
    </div>

    <div id="dashboard-section" class="hidden w-full max-w-lg pb-20">
        <div class="flex justify-between items-center mb-6 pt-4">
            <div class="flex items-center gap-3">
                <img id="user-photo" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-12 h-12 rounded-full border-2 border-purple-500">
                <div>
                    <h2 id="user-name" class="font-bold text-lg leading-tight">User</h2>
                    <span class="text-xs bg-purple-900 text-purple-200 px-2 py-0.5 rounded-full">Level 1</span>
                </div>
            </div>
            <div class="bg-gray-800 px-4 py-2 rounded-lg border border-yellow-600/50 text-center">
                <p class="text-xs text-gray-400">Balance</p>
                <p class="font-bold text-yellow-400 text-lg">ðŸª™ <span id="user-balance">0</span></p>
            </div>
        </div>

        <button id="admin-btn" onclick="openAdmin()" class="hidden w-full mb-4 bg-red-600/20 text-red-400 border border-red-600 py-2 rounded-lg font-bold">
            <i class="fas fa-shield-alt"></i> Open Admin Panel
        </button>

        <div class="bg-gradient-to-r from-indigo-900 to-purple-900 p-6 rounded-xl border border-purple-500 mb-6 relative overflow-hidden text-center shadow-lg">
            <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
            <h3 class="text-xl font-bold mb-1 text-white"><i class="fas fa-gem text-yellow-300"></i> Super Ad Zone</h3>
            <p class="text-purple-200 text-sm mb-4">Watch a premium ad & get HUGE rewards!</p>
            <button onclick="showMonetagReward()" class="bg-yellow-400 text-gray-900 px-8 py-3 rounded-full font-bold hover:scale-105 transition shadow-lg animate-pulse">
                WATCH AD (+50 Pts)
            </button>
        </div>

        <h3 class="text-xl font-bold mb-4 border-l-4 border-purple-500 pl-3">Play & Earn</h3>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div onclick="prepareGame('spin')" class="game-card bg-gray-800 p-4 rounded-xl text-center"><div class="text-blue-400 text-2xl mb-2"><i class="fas fa-dharmachakra"></i></div><h4 class="font-bold">Spin Wheel</h4><p class="text-xs text-gray-400">Win up to 50 Pts</p></div>
            <div onclick="prepareGame('scratch')" class="game-card bg-gray-800 p-4 rounded-xl text-center"><div class="text-green-400 text-2xl mb-2"><i class="fas fa-ticket-alt"></i></div><h4 class="font-bold">Scratch Card</h4><p class="text-xs text-gray-400">Scratch & Win</p></div>
            <div onclick="prepareGame('tap')" class="game-card bg-gray-800 p-4 rounded-xl text-center"><div class="text-red-400 text-2xl mb-2"><i class="fas fa-hand-pointer"></i></div><h4 class="font-bold">Tap Tap</h4><p class="text-xs text-gray-400">Tap fast in 10s</p></div>
            <div onclick="prepareGame('quiz')" class="game-card bg-gray-800 p-4 rounded-xl text-center"><div class="text-yellow-400 text-2xl mb-2"><i class="fas fa-question"></i></div><h4 class="font-bold">Math Quiz</h4><p class="text-xs text-gray-400">Solve & Earn</p></div>
        </div>

        <button onclick="document.getElementById('withdraw-modal').classList.remove('hidden')" class="w-full bg-gradient-to-r from-green-500 to-emerald-700 py-3 rounded-xl font-bold shadow-lg">Withdraw Earnings</button>
        <button onclick="logout()" class="w-full text-center text-gray-500 mt-4 text-sm">Logout</button>
    </div>

    <div id="loader-modal" class="hidden fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500 mb-4"></div><p>Loading...</p></div>

    <div id="game-spin" class="hidden fixed inset-0 bg-black/90 z-40 flex items-center justify-center p-4"><div class="glass p-6 w-full max-w-sm text-center relative"><button onclick="closeGame('game-spin')" class="absolute top-2 right-4 text-2xl">&times;</button><h3 class="text-xl font-bold mb-4">Spin the Wheel</h3><div class="relative w-64 h-64 mx-auto mb-4 bg-gray-700 rounded-full border-4 border-purple-500 overflow-hidden flex items-center justify-center"><div id="wheel" class="wheel-container w-full h-full rounded-full bg-[conic-gradient(red_0deg_60deg,blue_60deg_120deg,green_120deg_180deg,yellow_180deg_240deg,purple_240deg_300deg,orange_300deg_360deg)]"></div><div class="absolute top-0 w-4 h-8 bg-white" style="clip-path: polygon(50% 100%, 0 0, 100% 0);"></div></div><button onclick="runSpin()" class="bg-purple-600 px-8 py-2 rounded-full font-bold">SPIN</button></div></div>
    
    <div id="game-scratch" class="hidden fixed inset-0 bg-black/90 z-40 flex items-center justify-center p-4"><div class="glass p-6 w-full max-w-sm text-center relative"><button onclick="closeGame('game-scratch')" class="absolute top-2 right-4 text-2xl">&times;</button><h3 class="text-xl font-bold mb-4">Scratch & Win</h3><div class="relative w-64 h-32 mx-auto bg-white rounded-lg overflow-hidden flex items-center justify-center"><p class="text-black font-bold text-3xl" id="scratch-reward">0 Pts</p><div id="scratch-cover" onclick="revealScratch()" class="absolute inset-0 bg-gray-400 flex items-center justify-center cursor-pointer hover:bg-gray-500 transition"><span class="text-gray-800 font-bold">Tap to Scratch</span></div></div></div></div>

    <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 z-50 overflow-y-auto"><div class="p-6 max-w-4xl mx-auto"><div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Admin Dashboard</h2><button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="bg-gray-700 px-4 py-2 rounded">Close</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"><div class="bg-gray-800 p-6 rounded-xl"><p class="text-gray-400">Total Users</p><p class="text-3xl font-bold" id="adm-total-users">0</p></div><div class="bg-gray-800 p-6 rounded-xl"><p class="text-gray-400">Pending Withdrawals</p><p class="text-3xl font-bold text-yellow-400" id="adm-pending-wd">0</p></div></div><div id="wd-list-body" class="space-y-3"></div></div></div>

    <div id="withdraw-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div class="glass p-6 w-full max-w-sm relative"><button onclick="document.getElementById('withdraw-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400">&times;</button><h3 class="text-xl font-bold mb-4">Request Withdrawal</h3><select id="wd-method" class="w-full bg-gray-800 p-3 rounded mb-3 text-white"><option>bKash</option><option>Nagad</option></select><input id="wd-number" type="number" placeholder="Account Number" class="w-full bg-gray-800 p-3 rounded mb-3 text-white"><input id="wd-amount" type="number" placeholder="Points (Min 1000)" class="w-full bg-gray-800 p-3 rounded mb-4 text-white"><button onclick="submitWithdraw()" class="w-full bg-green-600 py-3 rounded font-bold">Submit</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === CONFIGURATION ===
        const firebaseConfig = {
          apiKey: "AIzaSyAfWlcUTfoEQIZN0uUvEysn6Bl-yLRUW-U",
          authDomain: "earning-b7215.firebaseapp.com",
          projectId: "earning-b7215",
          storageBucket: "earning-b7215.firebasestorage.app",
          messagingSenderId: "9316337032",
          appId: "1:9316337032:web:dfe33d9685934eec23a63d",
          measurementId: "G-9Z6L345EF1"
        };
        const ADMIN_EMAIL = "walid684@gmail.com"; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // === MONETAG IN-APP SETUP (Runs Automatically) ===
        // This runs the "frequency: 2" ads automatically as per your script
        try {
            if (typeof show_10454238 === 'function') {
                show_10454238({
                    type: 'inApp',
                    inAppSettings: {
                        frequency: 2,
                        capping: 0.1,
                        interval: 30,
                        timeout: 5,
                        everyPage: false
                    }
                });
            }
        } catch(e) { console.log("Ad script not loaded yet"); }

        // === AUTH HANDLER ===
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                handleUserLogin(user);
            } else {
                // Check if Telegram user is stored in LocalStorage
                const tgUser = localStorage.getItem('tg_user');
                if(tgUser) {
                    handleUserLogin(JSON.parse(tgUser), true);
                } else {
                    document.getElementById('login-section').classList.remove('hidden');
                    document.getElementById('dashboard-section').classList.add('hidden');
                }
            }
        });

        // SHARED LOGIN HANDLER (Google & Telegram)
        async function handleUserLogin(user, isTelegram = false) {
            currentUser = user;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            
            // Set Display Info
            let displayName = isTelegram ? user.first_name : user.displayName;
            let photoUrl = isTelegram ? user.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png" : user.photoURL;
            let uid = isTelegram ? `tg_${user.id}` : user.uid;
            
            // Allow Admin access if email matches or specific Telegram ID (optional)
            if(user.email === ADMIN_EMAIL) document.getElementById('admin-btn').classList.remove('hidden');

            document.getElementById('user-name').innerText = displayName;
            document.getElementById('user-photo').src = photoUrl;

            // Database Sync
            currentUser.uid = uid; // Ensure UID format consistency
            const ref = doc(db, "users", uid);
            const snap = await getDoc(ref);
            
            if(snap.exists()) {
                document.getElementById('user-balance').innerText = snap.data().balance;
            } else {
                await setDoc(ref, { 
                    name: displayName, 
                    email: user.email || "telegram_user", // Telegram might not give email
                    balance: 0, 
                    adsWatched: 0,
                    method: isTelegram ? 'Telegram' : 'Google',
                    joined: new Date().toISOString()
                });
            }
        }

        window.googleLogin = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.logout = () => {
            localStorage.removeItem('tg_user');
            signOut(auth);
            location.reload();
        };

        // === TELEGRAM CALLBACK ===
        // This function is called by the Telegram Widget
        window.onTelegramAuth = (user) => {
            alert('Logged in as ' + user.first_name);
            localStorage.setItem('tg_user', JSON.stringify(user));
            handleUserLogin(user, true);
        };

        // === MONETAG REWARDED AD LOGIC ===
        
        // 1. "Super Ad Zone" Function
        window.showMonetagReward = () => {
             // Calling the Rewarded Interstitial
             if (typeof show_10454238 === 'function') {
                show_10454238().then(() => {
                    // Success: User watched the ad
                    rewardUser(50, "Super Ad Zone"); // Give 50 Points
                }).catch(e => {
                    alert("Ad failed to load or closed too early. Try again.");
                });
             } else {
                 alert("AdBlock detected! Please disable AdBlocker.");
             }
        };

        // 2. Game Integration (Play -> Watch Ad -> Earn)
        window.prepareGame = (gameType) => {
            // Using the Rewarded Popup for Games for variety, or stick to interstitial
            show_10454238().then(() => {
                if(gameType === 'spin') document.getElementById('game-spin').classList.remove('hidden');
                if(gameType === 'scratch') { document.getElementById('game-scratch').classList.remove('hidden'); document.getElementById('scratch-cover').classList.remove('hidden'); }
                if(gameType === 'tap') alert("Tap Game Starting..."); 
                if(gameType === 'quiz') alert("Quiz Starting...");
            }).catch(e => {
                // If ad fails, maybe let them play anyway or show alert
                alert("Please watch the ad to play."); 
            });
        };

        window.closeGame = (id) => document.getElementById(id).classList.add('hidden');

        // --- GAME LOGIC (Spin/Scratch) ---
        window.runSpin = () => {
            const wheel = document.getElementById('wheel');
            const deg = Math.floor(5000 + Math.random() * 5000); 
            wheel.style.transform = `rotate(${deg}deg)`;
            setTimeout(() => rewardUser(20, "Spin Win"), 4000);
        };
        window.revealScratch = () => {
            document.getElementById('scratch-cover').classList.add('hidden');
            const pts = Math.floor(Math.random() * 15) + 5;
            document.getElementById('scratch-reward').innerText = `+${pts} Pts`;
            rewardUser(pts, "Scratch Card");
        };

        // --- GLOBAL REWARD FUNCTION ---
        async function rewardUser(amount, src) {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            try {
                const ref = doc(db, "users", currentUser.uid);
                await updateDoc(ref, { 
                    balance: increment(amount),
                    adsWatched: increment(1)
                });
                const cur = parseInt(document.getElementById('user-balance').innerText);
                document.getElementById('user-balance').innerText = cur + amount;
                // alert(`Success! Earned ${amount} pts from ${src}`);
            } catch(e) { console.error(e); }
        }

        // --- WITHDRAW & ADMIN (Simplified for brevity) ---
        window.submitWithdraw = async () => {
            // ... (Same withdrawal logic as before) ...
            const amt = parseInt(document.getElementById('wd-amount').value);
            const mtd = document.getElementById('wd-method').value;
            const num = document.getElementById('wd-number').value;
            if(amt < 1000) return alert("Min 1000 Pts");
            await addDoc(collection(db, "withdrawals"), {
                uid: currentUser.uid, name: document.getElementById('user-name').innerText,
                method: mtd, number: num, amount: amt, status: "Pending"
            });
            alert("Request Sent!");
        };

        window.openAdmin = async () => {
            document.getElementById('admin-modal').classList.remove('hidden');
            const snap = await getDocs(query(collection(db, "withdrawals"), where("status", "==", "Pending")));
            let html = '';
            snap.forEach(d => {
                const data = d.data();
                html += `<div class="bg-gray-700 p-2 mb-2 flex justify-between"><span>${data.number} (${data.amount})</span><button class="text-green-400">Approve</button></div>`;
            });
            document.getElementById('wd-list-body').innerHTML = html;
        };

    </script>
</body>
</html>
