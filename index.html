<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnPro - Real Cash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src='//libtl.com/sdk.js' data-zone='10454238' data-sdk='show_10454238'></script>

    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; user-select: none; }
        .glass { background: rgba(30, 41, 59, 0.9); border: 1px solid #334155; border-radius: 16px; }
        .btn-game { transition: transform 0.1s; }
        .btn-game:active { transform: scale(0.95); }
        .hidden { display: none !important; }
        
        /* Spin Wheel Animation */
        .wheel-outer { width: 200px; height: 200px; border-radius: 50%; border: 4px solid #a855f7; position: relative; overflow: hidden; transition: transform 4s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        .wheel-section { position: absolute; width: 100%; height: 100%; clip-path: polygon(50% 50%, 0 0, 100% 0); background: red; left: 0; top: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="login-view" class="w-full max-w-md mt-20 text-center glass p-8">
        <h1 class="text-4xl font-bold text-purple-500 mb-2">EarnPro</h1>
        <p class="text-gray-400 mb-8">Login via Google to start earning</p>
        <button onclick="handleGoogleLogin()" class="w-full bg-white text-black font-bold py-3 rounded-xl flex justify-center gap-2 hover:bg-gray-200">
            <i class="fab fa-google text-red-500 mt-1"></i> Login with Google
        </button>
    </div>

    <div id="dashboard-view" class="hidden w-full max-w-md pb-20">
        <div class="flex justify-between items-center mb-6 pt-4">
            <div class="flex items-center gap-3">
                <img id="u-img" class="w-12 h-12 rounded-full border-2 border-purple-500">
                <div>
                    <h2 id="u-name" class="font-bold">Loading...</h2>
                    <p class="text-xs text-green-400">‚óè Online</p>
                </div>
            </div>
            <div class="bg-gray-800 px-4 py-2 rounded-lg border border-yellow-500 text-center">
                <span class="block text-xs text-gray-400">Balance</span>
                <span class="font-bold text-yellow-400 text-xl">ü™ô <span id="u-bal">0</span></span>
            </div>
        </div>

        <button id="btn-admin" onclick="openAdmin()" class="hidden w-full mb-4 bg-red-900/50 text-red-400 border border-red-500 py-2 rounded font-bold">
            <i class="fas fa-lock"></i> Admin Control Panel
        </button>

        <div class="bg-gradient-to-r from-purple-900 to-indigo-900 p-6 rounded-xl border border-purple-500 mb-6 text-center relative overflow-hidden shadow-lg">
            <div class="absolute top-0 right-0 w-20 h-20 bg-white opacity-10 rounded-full blur-xl"></div>
            <h3 class="text-xl font-bold text-white mb-1">üöÄ Super Link Task</h3>
            <p class="text-purple-200 text-xs mb-3">Visit site & stay 10s to earn 50 Coins</p>
            <button onclick="openDirectLink()" class="bg-yellow-400 text-black px-6 py-2 rounded-full font-bold hover:scale-105 transition shadow-lg animate-pulse">
                GO NOW (+50)
            </button>
        </div>

        <h3 class="text-lg font-bold mb-3 border-l-4 border-purple-500 pl-3">Play Games (Rewarded Ads)</h3>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div onclick="playGame('spin')" class="glass p-4 text-center btn-game cursor-pointer">
                <i class="fas fa-dharmachakra text-3xl text-blue-400 mb-2"></i>
                <h4 class="font-bold">Spin Wheel</h4>
            </div>
            <div onclick="playGame('scratch')" class="glass p-4 text-center btn-game cursor-pointer">
                <i class="fas fa-ticket-alt text-3xl text-green-400 mb-2"></i>
                <h4 class="font-bold">Scratch Card</h4>
            </div>
            <div onclick="playGame('tap')" class="glass p-4 text-center btn-game cursor-pointer">
                <i class="fas fa-hand-pointer text-3xl text-red-400 mb-2"></i>
                <h4 class="font-bold">Tap Challenge</h4>
            </div>
            <div onclick="playGame('quiz')" class="glass p-4 text-center btn-game cursor-pointer">
                <i class="fas fa-brain text-3xl text-yellow-400 mb-2"></i>
                <h4 class="font-bold">Math Quiz</h4>
            </div>
        </div>

        <button onclick="openWithdraw()" class="w-full bg-green-600 py-3 rounded-xl font-bold shadow-lg mb-2">Withdraw Money</button>
        <button onclick="doLogout()" class="w-full text-gray-500 text-sm">Logout</button>
    </div>

    <div id="modal-spin" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center">
        <div class="text-center">
            <div id="wheel" class="wheel-outer mb-8 mx-auto bg-gray-800">
                <div class="absolute inset-0 bg-[conic-gradient(#ef4444_0deg_90deg,#3b82f6_90deg_180deg,#22c55e_180deg_270deg,#eab308_270deg_360deg)]"></div>
            </div>
            <button onclick="doSpin()" id="btn-spin-trigger" class="bg-purple-600 px-8 py-3 rounded-full font-bold text-xl">SPIN NOW</button>
            <button onclick="closeModals()" class="block mt-4 text-gray-500 mx-auto">Close</button>
        </div>
    </div>

    <div id="modal-tap" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center">
        <div class="text-center w-full max-w-xs">
            <h2 class="text-2xl font-bold mb-4">Tap Fast!</h2>
            <div class="text-4xl font-mono text-yellow-400 mb-2">Time: <span id="tap-time">10</span>s</div>
            <div class="text-2xl mb-6">Score: <span id="tap-score">0</span></div>
            <button id="btn-tap-action" onclick="countTap()" class="w-32 h-32 rounded-full bg-red-600 active:bg-red-800 font-bold text-xl shadow-lg mx-auto flex items-center justify-center">TAP!</button>
            <button onclick="startTap()" id="btn-tap-start" class="w-full bg-blue-600 py-2 rounded mt-6">Start Game</button>
            <button onclick="closeModals()" class="mt-4 text-gray-500">Close</button>
        </div>
    </div>

    <div id="modal-scratch" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center">
        <div class="glass p-6 text-center w-72">
            <h3 class="text-xl font-bold mb-4">Scratch Card</h3>
            <div class="relative w-full h-32 bg-white rounded-lg overflow-hidden flex items-center justify-center select-none">
                <span id="scratch-val" class="text-black text-3xl font-bold">+0</span>
                <div id="scratch-overlay" onclick="doScratch()" class="absolute inset-0 bg-gray-500 flex items-center justify-center cursor-pointer hover:bg-gray-600 transition">
                    <span class="font-bold">Click to Scratch</span>
                </div>
            </div>
            <button onclick="closeModals()" class="mt-6 text-gray-400">Close</button>
        </div>
    </div>

    <div id="admin-panel" class="hidden fixed inset-0 bg-gray-900 z-[60] overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h2 class="text-3xl font-bold text-red-500">Admin Control</h2>
                <button onclick="document.getElementById('admin-panel').classList.add('hidden')" class="bg-gray-700 px-4 py-2 rounded">Exit</button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-800 p-4 rounded border border-gray-700">
                    <p class="text-gray-400">Total Users</p>
                    <p class="text-2xl font-bold" id="adm-total-users">0</p>
                </div>
                <div class="bg-gray-800 p-4 rounded border border-gray-700">
                    <p class="text-gray-400">Ad System</p>
                    <button onclick="toggleAds()" id="btn-ad-toggle" class="mt-1 text-xs bg-green-600 px-2 py-1 rounded">Active</button>
                </div>
            </div>

            <h3 class="text-xl font-bold mb-2">User Manager</h3>
            <div class="bg-gray-800 rounded-lg overflow-hidden mb-6">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-700 text-gray-300">
                        <tr>
                            <th class="p-3">User</th>
                            <th class="p-3">Balance</th>
                            <th class="p-3">Action</th>
                        </tr>
                    </thead>
                    <tbody id="adm-user-list">
                        </tbody>
                </table>
            </div>

            <h3 class="text-xl font-bold mb-2">Pending Withdrawals</h3>
            <div id="adm-wd-list" class="space-y-2"></div>
        </div>
    </div>

    <div id="modal-withdraw" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="glass p-6 w-full max-w-sm">
            <h3 class="font-bold mb-4 text-xl">Withdraw Funds</h3>
            <input id="wd-amount" type="number" placeholder="Points (Min 1000)" class="w-full bg-gray-800 p-3 rounded mb-2 border border-gray-600">
            <input id="wd-num" type="text" placeholder="Number (bKash/Nagad)" class="w-full bg-gray-800 p-3 rounded mb-4 border border-gray-600">
            <div class="flex gap-2">
                <button onclick="submitWithdraw()" class="flex-1 bg-green-600 py-2 rounded font-bold">Submit</button>
                <button onclick="closeModals()" class="flex-1 bg-gray-600 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs, addDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === CONFIGURATION ===
        const firebaseConfig = {
          apiKey: "AIzaSyAfWlcUTfoEQIZN0uUvEysn6Bl-yLRUW-U",
          authDomain: "earning-b7215.firebaseapp.com",
          projectId: "earning-b7215",
          storageBucket: "earning-b7215.firebasestorage.app",
          messagingSenderId: "9316337032",
          appId: "1:9316337032:web:dfe33d9685934eec23a63d"
        };
        const ADMIN_EMAIL = "mdwld2005@gmail.com"; 
        const DIRECT_LINK = "https://otieu.com/4/10453862";
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let isAdEnabled = true;

        // AUTH
        window.handleGoogleLogin = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.doLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Ban Check
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists() && snap.data().banned) {
                    alert("Your account has been BANNED by Admin.");
                    await signOut(auth);
                    return;
                }
                
                // Show Dashboard
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('u-name').innerText = user.displayName;
                document.getElementById('u-img').src = user.photoURL;

                if (user.email === ADMIN_EMAIL) document.getElementById('btn-admin').classList.remove('hidden');
                syncBalance();
            }
        });

        async function syncBalance() {
            if(!currentUser) return;
            const ref = doc(db, "users", currentUser.uid);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                document.getElementById('u-bal').innerText = snap.data().balance;
            } else {
                await setDoc(ref, { 
                    name: currentUser.displayName, 
                    email: currentUser.email, 
                    balance: 0, 
                    banned: false,
                    joined: new Date().toISOString() 
                });
            }
        }

        // === 1. AD LOGIC (Specifics) ===
        
        // A. SPECIAL DIRECT LINK
        window.openDirectLink = () => {
            window.open(DIRECT_LINK, '_blank');
            // Add points after 10s delay logic (Simulated)
            setTimeout(async () => {
                if(confirm("Did you visit the link correctly?")) {
                    await updateDoc(doc(db, "users", currentUser.uid), { balance: increment(50) });
                    syncBalance();
                    alert("50 Coins Added!");
                }
            }, 8000);
        };

        // B. GAMES (REWARDED ADS)
        window.playGame = (game) => {
            if(!isAdEnabled) { alert("Ads are currently disabled by Admin."); return; }

            // Call Monetag SDK
            if (typeof show_10454238 === 'function') {
                show_10454238().then(() => {
                    // Ad Watched -> Open Game
                    openGameModal(game);
                }).catch(e => {
                    alert("Ad failed to load. Try again later.");
                    // For testing, you might uncomment this: openGameModal(game);
                });
            } else {
                alert("AdBlocker Detected! Please disable it.");
            }
        };

        // === 2. REAL GAME LOGIC ===
        function openGameModal(game) {
            if(game === 'spin') document.getElementById('modal-spin').classList.remove('hidden');
            if(game === 'tap') document.getElementById('modal-tap').classList.remove('hidden');
            if(game === 'scratch') {
                document.getElementById('modal-scratch').classList.remove('hidden');
                document.getElementById('scratch-overlay').classList.remove('hidden');
            }
        }

        window.closeModals = () => {
            document.querySelectorAll('[id^="modal-"]').forEach(el => el.classList.add('hidden'));
        };

        // SPIN
        window.doSpin = () => {
            const wheel = document.getElementById('wheel');
            const btn = document.getElementById('btn-spin-trigger');
            btn.disabled = true;
            
            // Random Rotation
            const deg = Math.floor(3000 + Math.random() * 3000); 
            wheel.style.transform = `rotate(${deg}deg)`;
            
            setTimeout(async () => {
                const win = [10, 20, 30, 50][Math.floor(Math.random()*4)];
                await addPoints(win);
                alert(`You won ${win} Coins!`);
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
                setTimeout(() => { wheel.style.transition = 'transform 4s'; }, 100);
                btn.disabled = false;
                closeModals();
            }, 4100);
        };

        // TAP
        let tapCount = 0; let tapTimer = null;
        window.startTap = () => {
            tapCount = 0;
            document.getElementById('tap-score').innerText = '0';
            document.getElementById('btn-tap-start').classList.add('hidden');
            let time = 10;
            
            tapTimer = setInterval(async () => {
                time--;
                document.getElementById('tap-time').innerText = time;
                if(time <= 0) {
                    clearInterval(tapTimer);
                    const win = Math.floor(tapCount / 2);
                    await addPoints(win);
                    alert(`Time Up! Score: ${tapCount}. You earned ${win} Coins.`);
                    document.getElementById('btn-tap-start').classList.remove('hidden');
                    closeModals();
                }
            }, 1000);
        };
        window.countTap = () => { tapCount++; document.getElementById('tap-score').innerText = tapCount; };

        // SCRATCH
        window.doScratch = async () => {
            document.getElementById('scratch-overlay').classList.add('hidden');
            const win = Math.floor(Math.random() * 20) + 5;
            document.getElementById('scratch-val').innerText = `+${win}`;
            await addPoints(win);
            setTimeout(() => { alert(`Collected ${win} Coins!`); closeModals(); }, 500);
        };

        async function addPoints(pts) {
            confetti();
            await updateDoc(doc(db, "users", currentUser.uid), { balance: increment(pts) });
            syncBalance();
        }

        // === 3. ADMIN PANEL CONTROLLER (POWERFUL) ===
        window.openAdmin = async () => {
            document.getElementById('admin-panel').classList.remove('hidden');
            loadAdminData();
        };

        async function loadAdminData() {
            // 1. Users List
            const uSnap = await getDocs(collection(db, "users"));
            document.getElementById('adm-total-users').innerText = uSnap.size;
            
            let html = '';
            uSnap.forEach(uDoc => {
                const u = uDoc.data();
                const uid = uDoc.id;
                html += `
                <tr class="border-b border-gray-700 bg-gray-800/50">
                    <td class="p-2">
                        <div class="font-bold text-white">${u.name}</div>
                        <div class="text-xs text-gray-500">${u.email}</div>
                        ${u.banned ? '<span class="text-red-500 text-xs font-bold">BANNED</span>' : ''}
                    </td>
                    <td class="p-2 text-yellow-400 font-mono">${u.balance}</td>
                    <td class="p-2 flex flex-col gap-1">
                        <button onclick="admAdjustBal('${uid}', 100)" class="bg-green-700 text-xs px-2 py-1 rounded">+100</button>
                        <button onclick="admAdjustBal('${uid}', -100)" class="bg-yellow-700 text-xs px-2 py-1 rounded">-100</button>
                        <button onclick="admToggleBan('${uid}', ${u.banned})" class="${u.banned ? 'bg-gray-500' : 'bg-red-600'} text-xs px-2 py-1 rounded">
                            ${u.banned ? 'Unban' : 'BAN'}
                        </button>
                    </td>
                </tr>`;
            });
            document.getElementById('adm-user-list').innerHTML = html;

            // 2. Withdrawals
            const wSnap = await getDocs(query(collection(db, "withdrawals"), where("status", "==", "Pending")));
            let wHtml = '';
            wSnap.forEach(wDoc => {
                const w = wDoc.data();
                wHtml += `
                <div class="bg-gray-800 p-3 rounded border border-gray-600 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm">${w.number}</p>
                        <p class="text-xs text-gray-400">${w.amount} pts</p>
                    </div>
                    <div>
                        <button onclick="admWdAction('${wDoc.id}', 'Paid')" class="bg-green-600 text-xs px-2 py-1 rounded mr-1">Pay</button>
                        <button onclick="admWdAction('${wDoc.id}', 'Reject')" class="bg-red-600 text-xs px-2 py-1 rounded">Reject</button>
                    </div>
                </div>`;
            });
            document.getElementById('adm-wd-list').innerHTML = wHtml || '<p class="text-gray-500 text-sm">No pending requests</p>';
        }

        // Admin Actions
        window.admAdjustBal = async (uid, amt) => {
            if(!confirm(`Change balance by ${amt}?`)) return;
            await updateDoc(doc(db, "users", uid), { balance: increment(amt) });
            loadAdminData(); // Refresh UI
        };

        window.admToggleBan = async (uid, currentStatus) => {
            if(!confirm(currentStatus ? "Unban user?" : "BAN USER? They cannot login.")) return;
            await updateDoc(doc(db, "users", uid), { banned: !currentStatus });
            loadAdminData();
        };

        window.admWdAction = async (id, status) => {
            await updateDoc(doc(db, "withdrawals", id), { status: status });
            loadAdminData();
        };
        
        // WITHDRAW FUNCTION (User Side)
        window.openWithdraw = () => document.getElementById('modal-withdraw').classList.remove('hidden');
        window.submitWithdraw = async () => {
            const amt = parseInt(document.getElementById('wd-amount').value);
            const num = document.getElementById('wd-num').value;
            if(amt < 1000 || !num) return alert("Invalid Input");
            
            // Check Balance
            const snap = await getDoc(doc(db, "users", currentUser.uid));
            if(snap.data().balance < amt) return alert("Insufficient Balance");

            await updateDoc(doc(db, "users", currentUser.uid), { balance: increment(-amt) });
            await addDoc(collection(db, "withdrawals"), {
                uid: currentUser.uid, amount: amt, number: num, status: "Pending", date: new Date().toISOString()
            });
            alert("Request Sent!");
            closeModals();
            syncBalance();
        };

    </script>
</body>
</html>
